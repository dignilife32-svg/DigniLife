#docker-compose.yml
services:
  db:
    image: postgres:16
    environment:
      POSTGRES_USER: appuser
      POSTGRES_PASSWORD: apppass
      POSTGRES_DB: dignilife
    ports: ["5432:5432"]
    volumes: [pgdata:/var/lib/postgresql/data]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 20

  redis:
    image: redis:7
    ports: ["6379:6379"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 2s
      retries: 30

  mailhog:
    image: mailhog/mailhog:v1.0.1
    ports: ["8025:8025"]
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "-", "http://localhost:8025/api/v2/healthz"]
      interval: 10s
      timeout: 3s
      retries: 12

  api:
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env.docker
    ports: ["8000:8000"]
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      mailhog:
        condition: service_started
    healthcheck:
      # 8000!! (မဟုတ် 88000)
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 2s
      retries: 10
    command: >
      bash -lc '
        ./ops/wait-for tcp:db:5432 60 &&
        ./ops/wait-for http://redis:6379 60 &&
        python -m src.db.create_tables_once || true &&
        uvicorn src.main:app --host 0.0.0.0 --port 8000 --workers 4
      '

  # --- Monitoring (profile: monitors) ---
  redis-exporter:
    image: bitnami/redis-exporter:latest
    environment: { REDIS_ADDR: "redis://redis:6379" }
    depends_on: [redis]
    ports: ["9121:9121"]
    profiles: ["monitors"]

  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./ops/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command: ["--config.file=/etc/prometheus/prometheus.yml"]
    ports: ["9090:9090"]
    depends_on: [api]
    profiles: ["monitors"]

  grafana:
    image: grafana/grafana:latest
    ports: ["3000:3000"]
    depends_on: [prometheus]
    profiles: ["monitors"]

volumes:
  pgdata:

