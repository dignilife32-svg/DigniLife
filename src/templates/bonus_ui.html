{% extends "base.html" %}

{% block title %}Admin · Bonus UI{% endblock %}

{% block content %}
<div class="layout">
  <aside class="sidebar">
    <div class="menu">
      <a class="menu-item" href="/admin/ui/dashboard">📊 Dashboard</a>
      <a class="menu-item" href="/admin/ui/bonus">🎁 Bonus UI</a>
      <a class="menu-item" href="/admin/reports">📁 Reports</a>
      <a class="menu-item" href="/admin/latency/ui">📈 Latency</a>
      <a class="menu-item" href="/admin/latency/history">🕒 Recent</a>
      <a class="menu-item" href="/admin/ui/logout">🚪 Logout</a>
    </div>
  </aside>

  <main class="content">
    <div class="topbar">
      <h1>Latency Monitor <small>(Bonus)</small></h1>
      <div style="opacity:.7;font-size:.9rem;">
        Last updated: <span id="last-updated">--:--:--</span>
      </div>
    </div>

    <div class="grid">
      <div class="card"><div>p50</div><div id="card-p50">0.0</div></div>
      <div class="card"><div>p90</div><div id="card-p90">0.0</div></div>
      <div class="card"><div>p99</div><div id="card-p99">0.0</div></div>
      <div class="card"><div>Average</div><div id="card-avg">0.0</div></div>
      <div class="card"><div>Count</div><div id="card-count">0</div></div>
      <div class="card"><div>Error rate</div><div id="card-error">0%</div></div>
      <div class="card"><div>Window (ms)</div><div id="card-window">60000</div></div>
      <div class="card"><div>Circuit</div><div id="card-circuit" style="color:lime;">OK</div></div>
    </div>

    <div style="height: 320px; margin-top: 1rem;">
      <canvas id="latencyChart"></canvas>
    </div>

    <div class="button-bar" style="margin-top: 1rem;">
      <button onclick="reset()" class="btn danger">Reset window</button>
      <button onclick="pause()" class="btn">Pause</button>
      <button onclick="loadData()" class="btn primary">Refresh</button>
    </div>
  </main>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let paused = false;
function pause() { paused = !paused; }
function reset() {
  fetch('/admin/latency/reset', { method: 'POST' });
}
async function loadData() {
  if (paused) return;
  const res = await fetch('/admin/latency/ui-data');
  const data = await res.json();
  const $ = id => document.getElementById(id);
  $('card-p50').innerText = data.p50;
  $('card-p90').innerText = data.p90;
  $('card-p99').innerText = data.p99;
  $('card-avg').innerText = data.avg;
  $('card-count').innerText = data.count;
  $('card-error').innerText = (data.error * 100).toFixed(2) + '%';
  $('card-window').innerText = data.window;
  $('card-circuit').innerText = data.ok ? 'OK' : 'ALERT';
  $('card-circuit').style.color = data.ok ? 'lime' : 'red';
  $('last-updated').innerText = new Date().toLocaleTimeString();

  chart.data.labels = data.series.map(x => x[0]);
  chart.data.datasets[0].data = data.series.map(x => x[1]);
  chart.data.datasets[1].data = data.series.map(x => x[2]);
  chart.update();
}
setInterval(loadData, 1000);
let chart = new Chart(document.getElementById('latencyChart'), {
  type: 'line',
  data: {
    labels: [],
    datasets: [
      { label: 'Latency (ms)', data: [], borderColor: '#0af', fill: false },
      { label: 'Errors (%)', data: [], borderColor: 'red', fill: false }
    ]
  },
  options: {
    scales: { y: { beginAtZero: true } },
    plugins: { legend: { display: true } }
  }
});
</script>
{% endblock %}
