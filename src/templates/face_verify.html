<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>DigniLife Face Verify</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50">
  <div class="max-w-md mx-auto p-6">
    <h1 class="text-2xl font-bold mb-4">Face Verification</h1>

    <div class="space-y-3">
      <label class="block">
        <span class="text-sm text-gray-600">User ID</span>
        <input id="userId" class="mt-1 w-full border rounded px-3 py-2" placeholder="user_123" />
      </label>

      <label class="block">
        <span class="text-sm text-gray-600">Operation</span>
        <select id="op" class="mt-1 w-full border rounded px-3 py-2">
          <option value="withdraw">withdraw</option>
          <option value="login">login</option>
          <option value="highrisk">highrisk</option>
        </select>
      </label>

      <div class="rounded-xl overflow-hidden bg-black">
        <video id="vid" autoplay playsinline class="w-full"></video>
      </div>

      <div class="flex gap-2">
        <button id="btnStart" class="px-4 py-2 rounded bg-blue-600 text-white">Start Camera</button>
        <button id="btnSnap"  class="px-4 py-2 rounded bg-slate-700 text-white" disabled>Capture & Verify</button>
      </div>

      <div id="status" class="text-sm text-gray-700"></div>

      <div id="result" class="hidden border rounded p-3 bg-white">
        <div class="font-semibold mb-1">Result</div>
        <div id="resultJson" class="font-mono text-xs whitespace-pre-wrap"></div>
        <a href="/ui/withdraw-demo" class="inline-block mt-3 text-blue-600 underline">Go to Withdraw Demo →</a>
      </div>
    </div>
  </div>

  <canvas id="canvas" class="hidden"></canvas>

<script>
  const API_BASE = ""; // same origin

  const $ = (id) => document.getElementById(id);
  const vid = $("vid");
  const canvas = $("canvas");
  const btnStart = $("btnStart");
  const btnSnap = $("btnSnap");
  const statusEl = $("status");
  const resultBox = $("result");
  const resultJson = $("resultJson");
  const userIdInput = $("userId");
  const opSelect = $("op");

  function getOrCreateDeviceId() {
    let id = localStorage.getItem("dl_device_id");
    if (!id) { id = crypto.randomUUID(); localStorage.setItem("dl_device_id", id); }
    return id;
  }
  function makeNonce() { return crypto.randomUUID() + "." + Math.floor(Date.now()/1000); }

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
      vid.srcObject = stream;
      btnSnap.disabled = false;
      setStatus("Camera ready. Click Capture & Verify.");
    } catch (e) { setStatus("Camera access denied: " + e.message, true); }
  }
  function frameToBase64() {
    const w = vid.videoWidth || 640, h = vid.videoHeight || 480;
    canvas.width = w; canvas.height = h;
    const ctx = canvas.getContext("2d"); ctx.drawImage(vid, 0, 0, w, h);
    return canvas.toDataURL("image/jpeg", 0.9).split(",")[1];
  }
  function setStatus(msg, isError=false) {
    statusEl.textContent = msg;
    statusEl.className = "text-sm " + (isError ? "text-red-600" : "text-gray-700");
  }

  async function verifyOnce() {
    const user_id = userIdInput.value.trim();
    if (!user_id) { setStatus("Please enter User ID.", true); return; }

    const device_id = getOrCreateDeviceId();
    const image_b64 = frameToBase64();
    const nonce = makeNonce();
    const op = opSelect.value;

    setStatus("Verifying…"); btnSnap.disabled = true;

    try {
      const res = await fetch(API_BASE + "/safety/face/verify", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_id, device_id, image_b64, nonce, op })
      });
      const data = await res.json();
      resultBox.classList.remove("hidden");
      resultJson.textContent = JSON.stringify(data, null, 2);

      if (res.ok && data.ok && data.token) {
        sessionStorage.setItem("dl_face_token", data.token);
        sessionStorage.setItem("dl_user_id", user_id);
        sessionStorage.setItem("dl_device_id", device_id);
        setStatus("Verified ✓ — token saved");
      } else {
        setStatus(`Failed: ${data.detail || data.reason || res.status}`, true);
      }
    } catch (e) { setStatus("Network error: " + e.message, true); }
    finally { btnSnap.disabled = false; }
  }

  btnStart.addEventListener("click", startCamera);
  btnSnap.addEventListener("click", verifyOnce);
</script>
</body>
</html>
