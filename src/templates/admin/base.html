<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}DigniLife Admin{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<style>
  .ai-reply{ position: relative; border-radius: 8px; padding: 10px; }
  .ai-reply.conf-good { border: 1px solid #22c55e22; background: #16a34a0a; }
  .ai-reply.conf-warn { border: 1px solid #f59e0b22; background: #f59e0b0a; }
  .ai-reply.conf-bad { border: 1px solid #ef444422; background: #ef44440a; }

  .ai-fb-bar { display:flex; align-items:center; gap:10px; margin-top:8px; opacity:.85; }
  .ai-fb-bar .fb { border:1px solid #ddd; background:#fff; border-radius:8px; padding:4px 8px; cursor:pointer; }
  .ai-fb-bar .fb:hover { filter:brightness(0.95); }
  .ai-fb-bar.sent .fb { opacity:.5; pointer-events:none; }
  .ai-fb-bar .fb-note { font-size:12px; color:#666; }
</style>

<body class="bg-light">
    <div class="container py-4">
        <h1 class="mb-4 text-center">DigniLife Admin</h1>
        {% block content %}{% endblock %}
    </div>
  </body>
  {% block scripts %}
<script>
const $  = (s)=>document.querySelector(s);
const $$ = (s)=>document.querySelectorAll(s);

// D6.1 ‚Äî core sender
async function sendFeedback({messageId, vote, text, reason, confidence, meta}) {
  try{
    const res = await fetch('/feedback/save', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({message_id: messageId, vote, text, reason, confidence, meta})
    });
    const j = await res.json();
    if(!res.ok) throw new Error(j.detail || 'feedback failed');
    return true;
  }catch(e){
    console.warn('feedback error:', e);
    return false;
  }
}

// D6.2 ‚Äî attach buttons to any .ai-reply blocks
function attachFeedbackToReplies(){
  $$('.ai-reply').forEach(el => {
    if (el.dataset.fbBound === '1') return;
    el.dataset.fbBound = '1';

    const msgId = el.dataset.msgId || ('m_' + Math.random().toString(36).slice(2));
    el.dataset.msgId = msgId;

    // read reason/confidence if present on element dataset
    const reason = el.dataset.reason || null;
    const conf   = el.dataset.confidence ? Number(el.dataset.confidence) : null;

    // confidence -> class
    if (conf != null){
      const c = conf >= 0.80 ? 'good' : (conf >= 0.50 ? 'warn' : 'bad');
      el.classList.add('conf-' + c);
    }

    const bar = document.createElement('div');
    bar.className = 'ai-fb-bar';
    bar.innerHTML = `
      <button class="fb up"   title="This was helpful">üëç</button>
      <button class="fb down" title="This was not helpful">üëé</button>
      <span class="fb-note">${reason ? `reason: ${reason}` : ''}</span>
    `;
    el.appendChild(bar);

    bar.querySelector('.up').addEventListener('click', async () => {
      await sendFeedback({messageId: msgId, vote:'up', reason, confidence: conf});
      bar.classList.add('sent');
    });
    bar.querySelector('.down').addEventListener('click', async () => {
      const txt = prompt('What went wrong? (optional)');
      await sendFeedback({messageId: msgId, vote:'down', text: txt || '', reason, confidence: conf});
      bar.classList.add('sent');
    });
  });
}

document.addEventListener('DOMContentLoaded', () => {
  attachFeedbackToReplies();
  // if replies are dynamically added, call attachFeedbackToReplies() after render
});
</script>
{% endblock %}

</html>

