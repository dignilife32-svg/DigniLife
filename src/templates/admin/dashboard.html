{% extends "base.html" %}
{% block title %}Admin Â· Dashboard{% endblock %}

{% block content %}
<h2 style="margin:0 0 .75rem 0">Latency Monitor (Dashboard)</h2>

<div style="display:flex; gap:1rem; align-items:center; margin-bottom:.5rem;">
  <div style="opacity:.7;font-size:.9rem;">
    Last updated: <span id="last-updated">--:--:--</span>
  </div>
  <button id="btn-refresh" class="btn btn-sm">Refresh</button>
  <button id="btn-pause" class="btn btn-sm">Pause</button>
  <button id="btn-reset" class="btn btn-sm btn-danger">Reset window</button>
</div>

<!-- KPI cards -->
<div class="grid">
  <div class="card"><div>p50</div><div id="card-p50">0.0</div></div>
  <div class="card"><div>p90</div><div id="card-p90">0.0</div></div>
  <div class="card"><div>p99</div><div id="card-p99">0.0</div></div>
  <div class="card"><div>Average</div><div id="card-avg">0.0</div></div>
  <div class="card"><div>Count</div><div id="card-count">0</div></div>
  <div class="card"><div>Error rate</div><div id="card-error">0%</div></div>
  <div class="card"><div>Window (ms)</div><div id="card-window">60000</div></div>
  <div class="card"><div>Circuit</div><div id="card-circuit" style="color:#18d36e">OK</div></div>
</div>

<!-- Chart -->
<div style="height: 320px; margin-top: 1rem;">
  <canvas id="latencyChart"></canvas>
</div>

<!-- Recent table -->
<h3 style="margin:1rem 0 .5rem 0;">Recent requests (latest 50)</h3>
<div class="table-wrap">
  <table class="table">
    <thead>
      <tr>
        <th style="width:130px;">ts</th>
        <th style="width:90px;">ms</th>
        <th style="width:80px;">error</th>
        <th>path</th>
      </tr>
    </thead>
    <tbody id="rows-body"></tbody>
  </table>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let paused = false;
let chart;

function fmt(n, d=1) { return Number(n).toFixed(d); }
function nowHHMMSS() { const d=new Date(); return d.toTimeString().slice(0,8); }

async function fetchJSON(url) {
  const r = await fetch(url, { cache: "no-store" });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

function ensureChart() {
  if (chart) return chart;
  const ctx = document.getElementById('latencyChart').getContext('2d');
  chart = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [
      { label: 'Latency (ms)', data: [], tension: .25, pointRadius: 2 },
      { label: 'Errors (0/1)', data: [], tension: 0, pointRadius: 0, yAxisID: 'y1' }
    ]},
    options: {
      animation: false,
      responsive: true,
      scales: {
        y: { type: 'linear', position: 'left', title: {display:true, text:'ms'} },
        y1: { type:'linear', position:'right', grid:{drawOnChartArea:false}, min:0, max:1, ticks:{stepSize:1} }
      },
      plugins: { legend: { display:true } }
    }
  });
  return chart;
}

async function loadOnce() {
  // KPIs
  const k = await fetchJSON('/admin/latency');
  document.getElementById('card-p50').textContent  = fmt(k.stats.p50 ?? 0);
  document.getElementById('card-p90').textContent  = fmt(k.stats.p90 ?? 0);
  document.getElementById('card-p99').textContent  = fmt(k.stats.p99 ?? 0);
  document.getElementById('card-avg').textContent  = fmt(k.stats.avg ?? 0);
  document.getElementById('card-count').textContent= k.stats.count ?? 0;
  document.getElementById('card-error').textContent= fmt((k.stats.error_rate ?? 0)*100, 2) + '%';
  document.getElementById('card-window').textContent= k.stats.window_ms ?? 60000;

  const circEl = document.getElementById('card-circuit');
  const ok = !(k.warn === true);
  circEl.textContent = ok ? 'OK' : 'WARN';
  circEl.style.color = ok ? '#18d36e' : '#ff6b6b';

  // History -> chart + table
  const hist = await fetchJSON('/admin/latency/history?limit=50');
  const labels = [];
  const ms     = [];
  const errs   = [];

  const tbody = document.getElementById('rows-body');
  tbody.innerHTML = '';

  (hist.rows || []).forEach(row => {
    const ts = new Date((row.ts || 0) * 1000).toTimeString().slice(0,8);
    labels.push(ts);
    ms.push(row.ms || 0);
    errs.push(row.error ? 1 : 0);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${ts}</td>
      <td>${fmt(row.ms || 0)}</td>
      <td style="color:${row.error ? '#ff6b6b' : '#18d36e'}">${row.error}</td>
      <td>${row.path || ''}</td>`;
    tbody.appendChild(tr);
  });

  const c = ensureChart();
  c.data.labels = labels.reverse();
  c.data.datasets[0].data = ms.reverse();
  c.data.datasets[1].data = errs.reverse();
  c.update();

  document.getElementById('last-updated').textContent = nowHHMMSS();
}

function tick() { if (!paused) loadOnce().catch(console.error); }
document.getElementById('btn-refresh').onclick = () => loadOnce();
document.getElementById('btn-pause').onclick = (e) => {
  paused = !paused;
  e.target.textContent = paused ? 'Resume' : 'Pause';
};
document.getElementById('btn-reset').onclick = async () => {
  await fetch('/admin/latency/reset', { method:'POST' });
  await loadOnce();
};

loadOnce();
setInterval(tick, 3000);
</script>
{% endblock %}
